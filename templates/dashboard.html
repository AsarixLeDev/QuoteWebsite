{% extends 'layout.html' %}
{% block content %}
<h2 style="margin-bottom:10px;">{{ 'Tous les textes' if current_user.is_admin else 'Vos textes' }}</h2>

{% if texts|length == 0 %}
<div class="card">
    <p>Aucun texte pour le moment.</p>
    {% if current_user.is_admin %}
    <p><a class="button" href="{{ url_for('texts.new_text') }}">Créer un premier texte</a></p>
    {% endif %}
</div>
{% else %}
<div class="grid" style="display:grid; gap:12px; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));">
    {% for t in texts %}
    <article class="card" style="display:flex; flex-direction:column; gap:8px;">
        <div style="display:flex; justify-content:space-between; gap:8px; align-items:baseline;">
            <h3 style="margin:0; font-size:1.05rem;">{{ t.title or '(sans titre)' }}</h3>
            <div class="text-muted" style="white-space:nowrap;">{{ t.date_dt.strftime('%d/%m/%Y %H:%M') }}</div>
            {% if t.media_badge %}
            <div class="badge" title="{{ t.media_badge.label }}">{{ t.media_badge.icon }} {{ t.media_badge.label }}
            </div>
            {% endif %}
        </div>
        {% if t.yt_job_id %}
        <div class="card subtle" data-job-id="{{ t.yt_job_id }}" style="margin-top:6px;">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
                <div><strong>Extraction audio YouTube</strong></div>
                {% if current_user.is_admin %}
                <div class="inline-actions">
                    <button class="button small danger btn-cancel">Annuler</button>
                    <button class="button small secondary btn-retry" style="display:none;">Relancer</button>
                </div>
                {% endif %}
            </div>
            <div class="progress" style="margin-top:6px;">
                <div class="progress-bar" style="width:0%"></div>
            </div>
            <div class="text-muted job-msg" style="margin-top:6px;">Préparation…</div>
        </div>
        {% endif %}

        {% if t.image_filename %}
        <img alt="" src="{{ url_for('core.uploaded_file', filename=t.image_filename) }}"
             style="width:100%; max-height:160px; object-fit:cover; border-radius:12px;">
        {% elif t.image_url %}
        <img alt="" src="{{ t.image_url }}" style="width:100%; max-height:160px; object-fit:cover; border-radius:12px;">
        {% endif %}

        {% if t.context %}
        <div class="text-muted" style="font-style:italic;">{{ t.context }}</div>
        {% endif %}

        <p style="margin:0; white-space:pre-wrap; line-height:1.5; max-height:7.2em; overflow:hidden;">
            {{ (t.body or '')[:300] }}{% if (t.body or '')|length > 300 %}…{% endif %}
        </p>

        <div style="display:flex; gap:8px; margin-top:auto; flex-wrap:wrap;">
            <a class="button" href="{{ url_for('texts.view_text', text_id=t.id) }}">Ouvrir</a>
            {% if current_user.is_admin %}
            <a class="button secondary" href="{{ url_for('texts.edit_text', text_id=t.id) }}">Modifier</a>
            {% endif %}
        </div>
    </article>
    {% endfor %}
</div>
{% endif %}
<script>
    (function(){
      const cards = document.querySelectorAll('[data-job-id]');
      if(!cards.length) return;

      async function pollOne(card){
        const id = card.getAttribute('data-job-id');
        const bar = card.querySelector('.progress-bar');
        const msg = card.querySelector('.job-msg');
        const btnCancel = card.querySelector('.btn-cancel');
        const btnRetry = card.querySelector('.btn-retry');

        try{
          const r = await fetch("/jobs/"+id+"/status");
          if(!r.ok){ msg.textContent = "Job inconnu."; return; }
          const j = await r.json();
          bar.style.width = (j.progress||0)+"%";
          msg.textContent = (j.state||"") + (j.message ? " — "+j.message : "");

          if(j.state === "done"){
            // recharge pour que la carte passe en "Audio local"
            location.reload(); return;
          }
          if(j.state === "error"){
            if(btnRetry) btnRetry.style.display = 'inline-block';
            if(btnCancel) btnCancel.disabled = true;
            return;
          }
          if(j.state === "cancelled"){
            msg.textContent = "Annulé";
            if(btnRetry) btnRetry.style.display = 'inline-block';
            return;
          }

          setTimeout(()=>pollOne(card), 1000);
        }catch(e){
          setTimeout(()=>pollOne(card), 2000);
        }

        {% if current_user.is_admin %}
        if(btnCancel && !btnCancel._bound){
          btnCancel._bound = true;
          btnCancel.addEventListener('click', async ()=>{
            btnCancel.disabled = true;
            await fetch("/jobs/"+id+"/cancel", {method:"POST"});
            setTimeout(()=>pollOne(card), 300);
          });
        }
        if(btnRetry && !btnRetry._bound){
          btnRetry._bound = true;
          btnRetry.addEventListener('click', async ()=>{
            btnRetry.disabled = true;
            const r = await fetch("/jobs/"+id+"/retry", {method:"POST"});
            if(r.ok) location.reload(); else btnRetry.disabled = false;
          });
        }
        {% endif %}
      }

      cards.forEach(pollOne);
    })();
</script>
{% endblock %}
