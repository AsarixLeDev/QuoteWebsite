{% extends 'layout.html' %}
{% block content %}
<h2>{{ 'Nouveau texte' if is_new else 'Modifier le texte' }}</h2>

<form method="post" enctype="multipart/form-data" class="card">
  <!-- Titre & Date -->
  <div class="form-row">
    <div>
      <label for="title">Titre (optionnel)</label>
      <input class="input" id="title" name="title" type="text"
             value="{{ (text.title or '') if text else '' }}" placeholder="(sans titre)">
    </div>
    <div>
      <label for="date">Date</label>
      <input class="input" id="date" name="date" type="datetime-local"
             value="{{ text.date_dt.strftime('%Y-%m-%dT%H:%M') if text and text.date_dt else '' }}">
      <div class="text-muted" style="margin-top:4px;">Laisse vide pour utiliser la date actuelle.</div>
    </div>
  </div>

  <!-- Contexte -->
  <label for="context" style="margin-top:10px;">Contexte (optionnel)</label>
  <textarea class="textarea" id="context" name="context" rows="3"
            placeholder="Contexte…">{{ (text.context or '') if text else '' }}</textarea>

  <!-- Corps -->
  <label for="body" style="margin-top:10px;">Texte *</label>
  <textarea class="textarea" id="body" name="body" rows="10" required
            placeholder="Écris ici…">{{ (text.body or '') if text else '' }}</textarea>

  <!-- Musique -->
  <div class="form-row" style="margin-top:10px;">
    <div>
      <label for="music_url">Musique — URL (optionnel) ou importer un fichier</label>
      <input class="input" type="text" id="music_url" name="music_url"
             inputmode="url" autocomplete="off" autocapitalize="off" spellcheck="false"
             value="{{ (text.music_input_value or text.music_original_url or text.music_url or '') if text else '' }}"
             placeholder="https://… (Spotify/YouTube/Deezer/Apple Music/MP3) ou /uploads/xxxx.mp3"
             pattern="^(https?://|/uploads/).*$"
             title="Entre une URL http(s) valide ou un chemin local /uploads/…">

      <!-- Switch YouTube audio (extraction) : visible seulement si lien YouTube -->
      <div id="yt-switch" style="display:none; margin-top:8px;">
        <label class="switch">
          <input type="checkbox" id="youtube_audio" name="youtube_audio" value="1"
                 {% if text and (text.youtube_audio_checked or text.youtube_mode=='audio') %}checked{% endif %}>
          <span class="switch-label">Audio uniquement (YouTube)</span>
        </label>
        <div class="text-muted" style="margin-top:4px;">
          Si coché, on extrait l’audio et on l’héberge localement (yt-dlp requis).
        </div>
      </div>
    </div>

    <div>
      <label for="music_file">Fichier audio (mp3, wav, ogg, m4a, aac — optionnel)</label>
      <input type="file" id="music_file" name="music_file" accept="audio/*">
      {% if text and text.music_url and text.music_url.startswith('/uploads/') %}
        <p class="text-muted">Fichier actuel : {{ text.music_url }}</p>
      {% endif %}
    </div>
  </div>

  <!-- Image -->
  <div class="form-row">
    <div>
      <label for="image_file">Image (optionnelle — upload)</label>
      <input type="file" id="image_file" name="image_file" accept="image/*">
      {% if text and text.image_filename %}
        <p class="text-muted">Image actuelle (upload) :
          <a class="link" href="{{ url_for('core.uploaded_file', filename=text.image_filename) }}" target="_blank">voir</a>
        </p>
      {% endif %}
    </div>
    <div>
      <label for="image_url">Image (optionnelle — URL)</label>
      <input class="input" type="text" id="image_url" name="image_url" inputmode="url"
             value="{{ (text.image_url or '') if text else '' }}"
             placeholder="https://… (si pas d’upload)">
    </div>
  </div>

  <!-- Permissions -->
  <div class="card subtle" style="margin-top:10px;">
    <div style="font-weight:700; margin-bottom:6px;">Qui peut voir ce texte ?</div>
    {% if users|length == 0 %}
      <div class="text-muted">Aucun utilisateur n’est défini. (Création depuis la console.)</div>
    {% else %}
      <div class="chip-group">
        {% for uname in users %}
          <label class="checkbox-pill">
            <input type="checkbox" name="allowed_users" value="{{ uname }}"
                   {% if text and text.allowed_usernames and uname in text.allowed_usernames %}checked{% endif %}>
            <span>{{ uname }}</span>
          </label>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <!-- Actions -->
  <div style="margin-top:16px; display:flex; gap:8px; flex-wrap:wrap;">
    <button class="button" type="submit">{{ 'Créer' if is_new else 'Enregistrer' }}</button>
    {% if text %}
      <a class="button secondary" href="{{ url_for('texts.view_text', text_id=text.id) }}">Annuler</a>
    {% else %}
      <a class="button secondary" href="{{ url_for('core.dashboard') }}">Annuler</a>
    {% endif %}
  </div>
</form>

<!-- JS: n’afficher le switch que si URL YouTube (watch / youtu.be / shorts) -->
<script>
(function(){
  const input = document.getElementById('music_url');
  const box = document.getElementById('yt-switch');
  const chk = document.getElementById('youtube_audio');

  function isYT(u){ return /(youtube\.com\/(watch\?v=|shorts\/)|youtu\.be\/)/i.test((u||'').trim()); }
  function refresh(){
    const show = isYT(input.value);
    box.style.display = show ? 'block' : 'none';
    if(!show && chk) chk.checked = false;
  }
  if(input){ input.addEventListener('input', refresh); }
  document.addEventListener('DOMContentLoaded', refresh);
})();
</script>
{% endblock %}
