{% extends 'layout.html' %}
{% block content %}
<h2>{{ 'Nouveau texte' if is_new else 'Modifier le texte' }}</h2>

<form method="post" enctype="multipart/form-data" class="card">
  <!-- Titre & Date -->
  <div class="form-row">
    <div>
      <label for="title">Titre (optionnel)</label>
      <input class="input" id="title" name="title" type="text"
             value="{{ (text.title or '') if text else '' }}" placeholder="(sans titre)">
    </div>
    <div>
      <label for="date">Date</label>
      <input class="input" id="date" name="date" type="datetime-local"
             value="{{ text.date_dt.strftime('%Y-%m-%dT%H:%M') if text and text.date_dt else '' }}">
      <div class="text-muted" style="margin-top:4px;">Laisse vide pour utiliser la date actuelle.</div>
    </div>
  </div>

  <!-- Contexte -->
  <label for="context" style="margin-top:10px;">Contexte (optionnel)</label>
  <textarea class="textarea" id="context" name="context" rows="3"
            placeholder="Contexte…">{{ (text.context or '') if text else '' }}</textarea>

  <!-- Corps -->
  <label for="body" style="margin-top:10px;">Texte *</label>
  <textarea class="textarea" id="body" name="body" rows="10" required
            placeholder="Écris ici…">{{ (text.body or '') if text else '' }}</textarea>

  <!-- Musique -->
  <div class="form-row" style="margin-top:10px;">
    <div>
      <label for="music_url">Musique — URL (optionnel) ou importer un fichier</label>
      <input class="input" type="text" id="music_url" name="music_url"
             inputmode="url" autocomplete="off" autocapitalize="off" spellcheck="false"
             value="{{ (text.music_input_value or text.music_original_url or text.music_url or '') if text else '' }}"
             placeholder="https://… (Spotify/YouTube/Deezer/Apple Music/MP3) ou /uploads/xxxx.mp3"
             pattern="^(https?://|/uploads/).*$"
             title="Entre une URL http(s) valide ou un chemin local /uploads/…">

      <!-- Switch YouTube audio (extraction) : visible seulement si lien YouTube -->
      <div id="yt-switch" style="display:none; margin-top:8px;">
        <label class="switch">
          <input type="checkbox" id="youtube_audio" name="youtube_audio" value="1"
                 {% if text and (text.youtube_audio_checked or text.youtube_mode=='audio') %}checked{% endif %}>
          <span class="switch-label">Audio uniquement (YouTube)</span>
        </label>
        <div class="text-muted" style="margin-top:4px;">
          Si coché, on extrait l’audio et on l’héberge localement (yt-dlp requis).
        </div>
      </div>
    </div>

    <div>
      <label for="music_file">Fichier audio (mp3, wav, ogg, m4a, aac — optionnel)</label>
      <input type="file" id="music_file" name="music_file" accept="audio/*">
      {% if text and text.music_url and text.music_url.startswith('/uploads/') %}
        <p class="text-muted">Fichier actuel : {{ text.music_url }}</p>
      {% endif %}
    </div>
  </div>

  <!-- Image -->
  <div class="form-row">
    <div>
      <label for="image_file">Image (optionnelle — upload)</label>
      <input type="file" id="image_file" name="image_file" accept="image/*">
      {% if text and text.image_filename %}
        <p class="text-muted">Image actuelle (upload) :
          <a class="link" href="{{ url_for('core.uploaded_file', filename=text.image_filename) }}" target="_blank">voir</a>
        </p>
      {% endif %}
    </div>
    <div>
      <label for="image_url">Image (optionnelle — URL)</label>
      <input class="input" type="text" id="image_url" name="image_url" inputmode="url"
             value="{{ (text.image_url or '') if text else '' }}"
             placeholder="https://… (si pas d’upload)">
    </div>
  </div>

  <!-- Permissions -->
  <div class="card subtle" style="margin-top:10px;">
  <div style="font-weight:700; margin-bottom:6px;">Qui peut voir ce texte ?</div>
    <label class="checkbox-pill" style="margin-bottom:8px;">
      <input type="checkbox" name="is_public" value="1"
             {% if text and text.is_public %}checked{% endif %}>
      <span>Public (visible par tous mes amis)</span>
    </label>
    <div class="text-muted" style="font-size:.9rem; margin-bottom:10px;">
      Si coché, tous vos amis pourront voir ce texte automatiquement.
      Vous pouvez en plus ajouter des personnes précises ci-dessous.
    </div>

  {% set SUGGEST = users or [] %}  {# liste côté serveur, sans admin #}
  {% set PRE = (text.allowed_usernames if text and text.allowed_usernames else []) %}

  {% if SUGGEST|length == 0 %}
    <div class="text-muted">Aucun utilisateur n’est défini (création depuis la console).</div>
  {% else %}

  <div class="perm-row" style="display:flex; flex-direction:column; gap:10px;">
    <div class="perm-input-wrap" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <input class="input" type="text" id="perm-input" placeholder="Ajouter un utilisateur…"
             autocomplete="off" autocapitalize="off" spellcheck="false"
             list="perm-suggest">
      <datalist id="perm-suggest">
        {% for u in SUGGEST %}<option value="{{ u }}">{% endfor %}
      </datalist>
      <button type="button" class="button small" id="perm-add">Ajouter</button>
    </div>

    <div id="perm-chips" class="chip-stack">
      {# Pré-sélection (édition) : on recrée les chips + inputs hidden #}
      {% for u in PRE %}
        <span class="chip" data-u="{{ u }}">
          {{ u }} <button class="chip-x" type="button" aria-label="Retirer" title="Retirer">&times;</button>
          <input type="hidden" name="allowed_users" value="{{ u }}">
        </span>
      {% endfor %}
    </div>

    <div class="text-muted" style="font-size:.9rem;">
      Astuce : tape un nom, vérifie le contour <em>(vert = existe, rouge = inconnu)</em>, puis “Entrée” ou “Ajouter”.
    </div>
  </div>

  {% endif %}
</div>

<script>
(function(){
  const SUGGEST = new Set({{ SUGGEST|tojson }});
  const input   = document.getElementById('perm-input');
  const addBtn  = document.getElementById('perm-add');
  const chips   = document.getElementById('perm-chips');

  function norm(s){ return (s||'').trim(); }

  function markValidity(){
    const v = norm(input.value);
    input.classList.remove('is-valid','is-invalid');
    if(!v){ return false; }
    const ok = SUGGEST.has(v);
    input.classList.add(ok ? 'is-valid' : 'is-invalid');
    return ok;
  }

  function alreadyAdded(u){
    return !!chips.querySelector('.chip[data-u="'+CSS.escape(u)+'"]');
  }

  function addUser(u){
    if(!u || !SUGGEST.has(u) || alreadyAdded(u)) return;
    const span = document.createElement('span');
    span.className = 'chip';
    span.setAttribute('data-u', u);
    span.innerHTML = `
      ${u}
      <button type="button" class="chip-x" aria-label="Retirer" title="Retirer">&times;</button>
      <input type="hidden" name="allowed_users" value="${u}">
    `;
    chips.appendChild(span);
  }

  function removeChip(btn){
    const chip = btn.closest('.chip');
    if(chip) chip.remove();
  }

  input.addEventListener('input', markValidity);
  input.addEventListener('change', markValidity);
  input.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
      e.preventDefault();
      if(markValidity()){
        const v = norm(input.value);
        addUser(v);
        input.value = '';
        input.classList.remove('is-valid','is-invalid');
      }
    }
  });

  if(addBtn){
    addBtn.addEventListener('click', ()=>{
      if(markValidity()){
        addUser(norm(input.value));
        input.value = '';
        input.classList.remove('is-valid','is-invalid');
      }
    });
  }

  chips.addEventListener('click', (e)=>{
    const btn = e.target.closest('.chip-x');
    if(btn) removeChip(btn);
  });
})();
</script>

  <!-- Actions -->
  <div style="margin-top:16px; display:flex; gap:8px; flex-wrap:wrap;">
    <button class="button" type="submit">{{ 'Créer' if is_new else 'Enregistrer' }}</button>
    {% if text %}
      <a class="button secondary" href="{{ url_for('texts.view_text', text_id=text.id) }}">Annuler</a>
    {% else %}
      <a class="button secondary" href="{{ url_for('core.dashboard') }}">Annuler</a>
    {% endif %}
  </div>
</form>

<!-- JS: n’afficher le switch que si URL YouTube (watch / youtu.be / shorts) -->
<script>
(function(){
  const input = document.getElementById('music_url');
  const box = document.getElementById('yt-switch');
  const chk = document.getElementById('youtube_audio');

  function isYT(u){ return /(youtube\.com\/(watch\?v=|shorts\/)|youtu\.be\/)/i.test((u||'').trim()); }
  function refresh(){
    const show = isYT(input.value);
    box.style.display = show ? 'block' : 'none';
    if(!show && chk) chk.checked = false;
  }
  if(input){ input.addEventListener('input', refresh); }
  document.addEventListener('DOMContentLoaded', refresh);
})();
</script>
{% endblock %}
