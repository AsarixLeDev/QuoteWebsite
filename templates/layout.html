<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width,initial-scale=1" name="viewport">
    <title>{{ site_name }}</title>
    <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
</head>
<script>
document.addEventListener('DOMContentLoaded', function(){
  // volume par d√©faut pour tous les <audio>
  document.querySelectorAll('audio').forEach(a => { try{ a.volume = 0.2; }catch(e){} });
});
</script>
<body>

<nav class="nav">
  <div class="nav-row">
    <div class="brand">
      <a class="link" href="{{ url_for('core.dashboard') }}">{{ site_name }}</a>
    </div>

    <!-- Ic√¥nes fixes √† droite (toujours visibles) -->
    <div class="nav-icons">
      {% if has_spotify %}
        <a class="icon-btn" href="{{ url_for('spotify.connect') }}" title="{{ 'Spotify connect√©' if spotify_connected else 'Se connecter √† Spotify' }}">üéß</a>
      {% endif %}

      {% if current_user.is_authenticated %}
        <!-- Bouton Amis -->
        <a class="icon-btn" href="{{ url_for('friends.friends_home') }}" title="Mes amis">
          üë•
          {% if friend_pending_count|default(0) > 0 %}
            <span class="dot" aria-label="{{ friend_pending_count }} demande(s) en attente"></span>
          {% endif %}
        </a>

        <a class="icon-btn" href="{{ url_for('core.logout_view') }}" title="Se d√©connecter">‚éã</a>
      {% endif %}

      <button class="icon-btn nav-toggle" aria-expanded="false" aria-controls="nav-menu" title="Menu">‚ò∞</button>
    </div>
  </div>

  <!-- Menu principal : gauche = nav ; droite = actions -->
  <div id="nav-menu" class="nav-menu">
    {% if current_user.is_authenticated %}
      <div class="nav-left">
        <span class="badge user"
              title="{{ current_user.get_id() }}{% if current_user.is_admin %} (admin){% endif %}">
          <span class="label">Connect√© :</span>
          <span class="uname">{{ current_user.get_id() }}</span>
          {% if current_user.is_admin %}
            <span class="role">(admin)</span>
            <span class="admin-chip" aria-label="Admin" title="Admin">A</span>
          {% endif %}
        </span>

        <a class="btn-nav" href="{{ url_for('core.dashboard') }}">Backboard</a>

          <a class="btn-nav" href="{{ url_for('texts.new_text') }}">Nouveau texte</a>
        {% if current_user.is_admin %}
          <a class="btn-nav" href="{{ url_for('core.admin_import') }}">Importer</a>
          <a class="btn-nav" href="{{ url_for('core.admin_backup') }}">T√©l√©charger backup</a>
        {% endif %}
      </div>

      <div class="nav-right">
        {% if has_spotify %}
          {% if spotify_connected %}
            <a class="btn-nav success" href="{{ url_for('spotify.connect') }}">Spotify connect√©</a>
            <a class="btn-nav" href="{{ url_for('spotify.disconnect') }}">D√©connecter Spotify</a>
          {% else %}
            <a class="btn-nav" href="{{ url_for('spotify.connect') }}">Se connecter Spotify</a>
          {% endif %}
        {% endif %}
        <a class="btn-nav danger" href="{{ url_for('core.logout_view') }}">Se d√©connecter</a>
      </div>
    {% else %}
      <div class="nav-left">
        <a class="btn-nav" href="{{ url_for('core.login') }}">Se connecter</a>
      </div>
    {% endif %}
  </div>
</nav>

<script>
(function(){
  const btn  = document.querySelector('.nav-toggle');
  const menu = document.getElementById('nav-menu');
  const left = document.querySelector('.nav-left');
  const right= document.querySelector('.nav-right');

  function setCollapsed(on){
    menu.classList.toggle('force-collapse', on);
    btn.classList.toggle('show', on);
    if(!on){ menu.classList.remove('open'); }
  }

  function recompute(){
    // mesure propre (m√™me si d√©j√† repli√©)
    const wasDisplay = menu.style.display;
    menu.style.display = 'flex';
    const need = (left && right) ? (left.scrollWidth + right.scrollWidth + 16 > menu.clientWidth) : false;
    menu.style.display = wasDisplay;

    const isNarrow = window.matchMedia('(max-width: 720px)').matches;
    setCollapsed(need || isNarrow);

    // Compacte le badge si la partie gauche d√©borde
    const badge = document.querySelector('.badge.user');
    if (badge && left) {
      badge.classList.toggle('compact', left.scrollWidth > left.clientWidth);
    }
  }

  btn.addEventListener('click', ()=>{
    const open = btn.getAttribute('aria-expanded') === 'true';
    btn.setAttribute('aria-expanded', String(!open));
    menu.classList.toggle('open', !open);
  });

  window.addEventListener('resize', recompute);
  document.addEventListener('DOMContentLoaded', ()=>{ setTimeout(recompute, 50); });
})();
</script>
<script>
(function(){
  function isAdmin(badge){ return !!badge.querySelector('.admin-chip'); }

  function compactBadge(){
    const badge = document.querySelector('.badge.user') || document.querySelector('.badge');
    if(!badge) return;

    // force la m√™me taille que les boutons en mobile
    const isMobile = window.matchMedia('(max-width: 720px)').matches;
    if(isMobile){
      badge.style.width  = 'min(var(--btn-w), 100%)';
      badge.style.height = 'var(--btn-h)';
    } else {
      badge.style.width = badge.style.height = '';
    }

    const menu = document.getElementById('nav-menu');
    const menuOpen = !!(menu && menu.classList.contains('open'));
    const veryNarrow = window.matchMedia('(max-width: 480px)').matches;

    const overflow   = badge.scrollWidth > badge.clientWidth;
    const forceSmall = veryNarrow || (menuOpen && isMobile);
    const makeCompact = overflow || forceSmall;

    badge.classList.toggle('compact', makeCompact);

    // contenu : admin => pastille A, sinon => uniquement username
    const children = Array.from(badge.children);
    const unameEl  = badge.querySelector('.uname');
    const chipEl   = badge.querySelector('.admin-chip');

    if (makeCompact){
      if (isAdmin(badge)){
        children.forEach(el => { if (el !== chipEl) el.style.display = 'none'; });
        if (chipEl) chipEl.style.display = 'inline-flex';
      } else {
        children.forEach(el => { if (el !== unameEl) el.style.display = 'none'; });
        if (unameEl) unameEl.style.display = '';
      }
    } else {
      children.forEach(el => { el.style.display = ''; });
    }
  }

  window.addEventListener('resize', compactBadge);
  document.addEventListener('DOMContentLoaded', () => setTimeout(compactBadge, 50));
  const btn = document.querySelector('.nav-toggle');
  if (btn){ btn.addEventListener('click', () => setTimeout(compactBadge, 50)); }
})();
</script>

{% with messages = get_flashed_messages() %}
{% if messages %}
<div class="flash-list">
    {% for m in messages %}
    <div class="flash">{{ m }}</div>
    {% endfor %}
</div>
{% endif %}
{% endwith %}

<main class="container">
    {% block content %}{% endblock %}
</main>

</body>
</html>
