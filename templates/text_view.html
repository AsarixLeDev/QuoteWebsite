{% extends 'layout.html' %}
{% block content %}

{% set embed = text.embed if text.embed is defined else {'type':'none','src':None} %}

<div class="card">
  <!-- Titre + date -->
  <div style="display:flex; justify-content: space-between; align-items: baseline; gap: 12px; flex-wrap: wrap;">
    <h2 style="margin:0;">{{ text.title or '(sans titre)' }}</h2>
    {% if text.date_dt is defined %}
      <div class="text-muted">{{ text.date_dt.strftime('%d/%m/%Y %H:%M') }}</div>
    {% elif text.date is defined %}
      <div class="text-muted">{{ text.date }}</div>
    {% endif %}
  </div>

  {% if current_user.is_admin and text.created_by %}
    <div class="text-muted" style="margin-top:-4px;">par {{ text.created_by }}</div>
  {% endif %}

  <!-- Image -->
  {% if text.image_filename %}
    <div style="margin:12px 0;">
      <img src="{{ url_for('core.uploaded_file', filename=text.image_filename) }}" alt="image"
           style="max-width:100%; border-radius:16px; box-shadow: var(--shadow);">
    </div>
  {% elif text.image_url %}
    <div style="margin:12px 0;">
      <img src="{{ text.image_url }}" alt="image"
           style="max-width:100%; border-radius:16px; box-shadow: var(--shadow);">
    </div>
  {% endif %}

  <!-- Contexte -->
  {% if text.context %}
    <p class="text-muted"><em>{{ text.context }}</em></p>
  {% endif %}

  <!-- Corps (déjà déchiffré côté serveur dans routes_texts.py) -->
  <div style="white-space: pre-wrap; line-height: 1.65;">
    {{ text.body }}
  </div>

  <!-- Musique -->
  {% set has_music = (text.music_url or embed.type != 'none') %}
  {% if has_music %}
    <hr>

    {# Cas spécial : YouTube en extraction audio (job en cours) #}
    {% if text.youtube_mode == 'audio' and (not text.music_url) and text.yt_job_id %}
      <div class="card subtle" id="yt-job" style="background:#fbfdff;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
          <div style="font-weight:700;">Chargement… extraction de l’audio YouTube</div>
          {% if current_user.is_admin %}
            <div class="inline-actions">
              <button class="button small danger" id="btn-cancel">Annuler</button>
              <button class="button small secondary" id="btn-retry" style="display:none;">Relancer</button>
            </div>
          {% endif %}
        </div>
        <div class="progress" style="margin-top:8px;">
          <div class="progress-bar" id="yt-progress" style="width:0%"></div>
        </div>
        <div class="text-muted" id="yt-msg" style="margin-top:6px;">Préparation…</div>
      </div>

      <script>
      (function(){
        const jobId = "{{ text.yt_job_id }}";
        const bar = document.getElementById('yt-progress');
        const msg = document.getElementById('yt-msg');
        const btnCancel = document.getElementById('btn-cancel');
        const btnRetry  = document.getElementById('btn-retry');

        async function poll(){
          try{
            const r = await fetch("/jobs/"+jobId+"/status");
            if(!r.ok){ if(msg) msg.textContent="Job inconnu."; return; }
            const j = await r.json();
            if(bar) bar.style.width = (j.progress||0)+"%";
            if(msg) msg.textContent = (j.state||"") + (j.message ? " — "+j.message : "");
            if(j.state === "done"){ location.reload(); return; }
            if(j.state === "error"){ if(btnRetry) btnRetry.style.display='inline-block'; if(btnCancel) btnCancel.disabled=true; return; }
            if(j.state === "cancelled"){ if(msg) msg.textContent="Annulé"; if(btnRetry) btnRetry.style.display='inline-block'; return; }
            setTimeout(poll, 1000);
          }catch(e){
            setTimeout(poll, 2000);
          }
        }

        {% if current_user.is_admin %}
        if(btnCancel){
          btnCancel.addEventListener('click', async ()=>{
            btnCancel.disabled = true;
            await fetch("/jobs/"+jobId+"/cancel", {method:"POST"});
            setTimeout(poll, 300);
          });
        }
        if(btnRetry){
          btnRetry.addEventListener('click', async ()=>{
            btnRetry.disabled = true;
            const r = await fetch("/jobs/"+jobId+"/retry", {method:"POST"});
            if(r.ok) location.reload(); else btnRetry.disabled=false;
          });
        }
        {% endif %}

        if(jobId){ poll(); }
      })();
      </script>

    {% else %}
      {# 1) Fichier local (upload ou extraction terminée) #}
      {% if text.music_url and text.music_url.startswith('/uploads/') %}
        <audio controls style="width:100%"><source src="{{ text.music_url }}"></audio>
        {% if text.music_original_url %}
          <p class="text-muted" style="margin-top:6px;">Source originale : {{ text.music_original_url }}</p>
        {% endif %}

      {# 2) Audio direct #}
      {% elif embed.type == 'audio_direct' %}
        <audio controls style="width:100%"><source src="{{ embed.src }}"></audio>

      {# 3) Spotify #}
      {% elif embed.type == 'spotify' %}
        <iframe
          style="border-radius:12px; width:100%; height:152px;"
          src="{{ embed.src }}"
          frameborder="0"
          allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
          loading="lazy"></iframe>

      {# 4) YouTube #}
      {% elif embed.type == 'youtube' %}
        <div class="iframe-wrap">
          <iframe
            src="{{ embed.src }}"
            title="YouTube"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen
            loading="lazy"></iframe>
        </div>

      {# 5) SoundCloud #}
      {% elif embed.type == 'soundcloud' %}
        <iframe
          width="100%" height="166"
          scrolling="no" frameborder="no"
          allow="autoplay"
          src="{{ embed.src }}" loading="lazy"></iframe>

      {# 6) Deezer #}
      {% elif embed.type == 'deezer' %}
        <iframe
          title="Deezer"
          src="{{ embed.src }}"
          width="100%"
          height="{{ 180 if embed.kind == 'track' else 450 }}"
          frameborder="0"
          allowtransparency="true"
          allow="encrypted-media; clipboard-write; autoplay"
          loading="lazy"></iframe>

      {# 7) Apple Music #}
      {% elif embed.type == 'applemusic' %}
        <iframe
          allow="autoplay *; encrypted-media *; clipboard-write"
          height="175"
          style="width:100%; overflow:hidden; background:transparent;"
          sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-storage-access-by-user-activation allow-top-navigation-by-user-activation"
          frameborder="0"
          loading="lazy"
          src="{{ embed.src }}"></iframe>

      {# 8) Fallback : simple lien #}
      {% else %}
        {% if text.music_url %}
          <p>Musique : <a class="link" href="{{ text.music_url }}" target="_blank" rel="noopener">{{ text.music_url }}</a></p>
        {% endif %}
      {% endif %}
    {% endif %}
  {% endif %}

  <!-- Actions -->
  <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
    {% set is_owner = (text.created_by is defined and text.created_by == current_user.get_id()) %}
    {% if current_user.is_admin or is_owner %}
      <a class="button secondary" href="{{ url_for('texts.edit_text', text_id=text.id) }}">Modifier</a>
      <form method="post" action="{{ url_for('texts.delete_text', text_id=text.id) }}"
            onsubmit="return confirm('Supprimer ce texte ?');" style="margin:0;">
        <button class="button danger" type="submit">Supprimer</button>
      </form>
    {% endif %}
    <a class="button" href="{{ url_for('core.dashboard') }}">Retour</a>
  </div>
</div>

{% endblock %}
